pico-8 cartridge // http://www.pico-8.com
version 34
__lua__


function _init()
	local num_video_files = 7
	local last_video_file_len = 14754
	local num_headers_files = 3
	local last_headers_file_len = 4240
	
	print("lOADING VIDEO...")
	video = import_str_from_carts("video", num_video_files, last_video_file_len)
	
	print("lOADING FRAME HEADERS...")
	headers = import_str_from_carts("headers", num_headers_files, last_headers_file_len)
	
	palt(0, false)
	// frame, vid_len, is 32 bit unsigned
	frame = 1>>>16
	vid_len = (#headers>>>16) / 6
	num_tiles = 0
	num_frame_heads = 0

	//how big pixels are
	pxsize = 4
	//how big tiles are in big pixels
	tsize = 4
	//y coordinate of top of screen
	topy = 16

	col_b = 0
	col_w = 7

	wtiles = 8
	htiles = 6

	wait = 6

--	testmode = false
--	testmodestr = ""
	cls()
	rectfill(0, topy, 127, 127-topy, col_b)
	main()
end

function main()

	while true do
	 //fps limiter
		if wait > 0 then
			wait -= 1
			goto next_frame
		end
--		if (btnp(🅾️)) testmode = not testmode
--		
--		if testmode then
--			if (not btnp(❎)) goto next_frame
--			testmodestr = ""
--		end
		
		if (frame == 1>>>16) music()
		
		if frame <= vid_len then
	--		fstr = video[frame]
	--		if (#fstr == 0) frame += 1 return
			//get frame info
			rowheads = {ord(headers, num_frame_heads*6 + 1, 6)}
			num_frame_heads += 1
			// make sure string indices don't overflow
			if num_frame_heads == 0x1555 then
				headers = sub(headers, 0x7FFF)
				num_frame_heads = 0
			end
			// loop through rows/tiles
			for ty = 0, #rowheads-1 do
				local row = rowheads[ty + 1]
				row = 255 - row
--				testmodestr ..= " " .. row
				if row != 0 then
					for tx = 0, 7 do
						if (0x1 << (7-tx)) & row ~= 0 then
							local ttop, tbot = ord(video, num_tiles * 2 + 1, 2)
							ttop = 255 - ttop
							tbot = 255 - tbot
							num_tiles += 1
							filltile(tx, ty, ttop, tbot)
							// make sure string indices don't overflow
							if num_tiles == 0x3FFF then
								video = sub(video, 0x7FFF)
								num_tiles = 0
							end
						end
					end
				end
			end
		else
			cls()
			return
		end
		frame += 1>>>16
		::next_frame::
		flip()
	end
end


function import_str_from_carts(file_prefix, num_files, last_file_len)
	local bufferaddr = 0x8000
    local out = ""
    for i = 1, num_files do
        local currfile = file_prefix .. i .. ".p8"
        local readlen = (i == num_files) and last_file_len or 0x4300
        reload(bufferaddr, 0x0, readlen, currfile)
        out ..= read_str_from_mem(bufferaddr, readlen)
        memset(bufferaddr,0x0,readlen)
    end
    return out
end

function load_file_to_mem(dest, write_cap)
    local written = 0
    if (not stat(120)) return nil
    while stat(120) do
        serial(0x800, dest + written, 1)
        written += 1
        if (written == 0x8000 or written == write_cap) print("hit write cap") break
        if (dest + written - 1 == 0xFFFF) print("hit memory cap") break
    end
    return written
end

function read_str_from_mem(addr, len)
    local out = ""
    while len != 0 do
        local readsize = len % 0x2000
        if (readsize == 0) readsize = 0x2000
        out ..= chr(peek(addr, readsize))
        addr += readsize 
        len -= readsize
    end
    return out
end


//fills tile in spritesheet
function filltile(tx, ty, topnum, botnum)
	//tx, ty are tile coordinates
	//tnum is tile pixel bitfield as num
	local xstart = tx * tsize * 4
	local ystart = ty * tsize * 4 + topy
	local curnum = topnum
	
	for i = 0, 15 do
		local px = xstart + (i % 4) * 4
		local py = ystart + (i \ 4) * 4
		if (i == 8) curnum = botnum
		if (curnum >>> (7 - i%8)) & 1 == 1 then
			flippixels(px, py, 4)
		end
	end
end


function flippixels(x, y, w)
	local oldcol = pget(x, y)
	local newcol = (oldcol == col_b) and col_w or col_b
	rectfill(x, y, x+w-1, y+w-1, newcol)
--	print(x .. " " .. y .. " " .. w)
end


__sfx__
000d0020286701c661106510c6450c6000c6001f600186000c6000c6001f600186000c6000c6000c6000c6000c6000c6001f600186000c6000c6001f600186000c6000c6001f600186000c600000000c60000000
010d00000c6553761537610376150c6553761537610376150c6553761537610376150c6550c6550c6550c6550c6553761537610376150c6553761537610376150c6553761537610376150c655376150c65537615
010d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000061404611076210b6210c631106311364117641186511c6511f6611f6651f6601f6650000000000
010d00000c6553761537610376150c6553761537610376150c6553761537610376150c6550c6550c6550c6550c6550c60037600376000c6550c60037600376000c6550c600376003760037615376000c60037600
010d00000c6753761537610376150c6753761537610376150c6753761537610376150c6753761537610376150c6753761537610376150c6753761537610376150c6753761537610376150c6750c6750c6750c675
010d0000072400724507240132400030013240112411324007240072450724013240003001324011241132400724007245072401324000300132401124113240072400724013240162400a2400a2401624018240
010d00000724007245072401324000300132401124113240072400724507240132400030013240112411324007240072450724013240003001324011241132401824018240162401824016240162401324016240
010d00000c6753761537610376150c6753761537610376150c6753761537610376150c6753761537610376150c6753761537610376150c6753761537610376150c675122000c6750c6750c6750f2000c6750c675
010d000013360133601536015360163601636018360183601a3601a3621a3621a3651f3601f3601d3601d3601a3601a3601a36013361133601336013360133651a3601a360183601836016360163601536015360
010d000013360133601536015360163601636018360183601a3601a3621a3621a3651836018360163601636015360153601336013360153601536016360163601536215362133601336012360123601536015360
010d00000324003245032400f240003000f2400d2410f2400324003245032400f240003000f2400d2410f2400524005245052401124000300112400f241112400524005245052401124000300112400f24111240
010d000013360133601536015360163601636018360183601a3601a3621a3621a365183601836016360163601536015360153601536516360163601636016365183601836018360183601a3611a3601a3601a365
010d00000c6753761537610376150c6753761537610376150c6753761537610376150c6753761537610376150c634106311364117641186511c6511f6611f6650c675122000c6750c6750c6750f2000c6750c675
010d00000e3300e330113301133013330133301533015330163301633216332163351a3301a33018330183301633016330163300e3310e3300e3300e3300e3351633016330153301533013330133301133011330
010d00000e3300e33011330113301333013330153301533016330163321633216335153301533013330133301233012330103301033012330123301333013330123301233010330103300e3300e3301233012330
010d00000e3300e330113301133013330133301533015330163301633216332163351533015330133301333018053000000000000000180530000018000000001807300000180731807318073000001807318073
010d00000f44613446164460a4460f44613446164460a4460f44613446164460a4460f44613446164460a4461144615446184460c4461144615446184460c4461144615446184460c4461144615446184460c446
010d000013446164461a4460e44613446164461a4460e44613446164461a4460e44613446164461a4460e44613446164461a4460e44613446164461a4460e44613446164461a4460e44613446164461a4460e446
010d0000286701c661106510c6450c6753761537610376150c6753761537610376150c6753761537610376150c6753761537610376150c6753761537610376150c6753761537610376150c675376150c67537615
010d00001d3501d3501f3501f3501a3501a35018350183501a3521a3521a3521a35518350183501a3501a3501d3501d3501f3501f3501a3501a35018350183501a3521a3521a3521a35518350183501a3501a350
010d00000c6753761537610376150c6753761537610376150c6753761537610376150c6753761537610376150c6753761537610376150c6753761537610376150c675376150c675376150c675376153761037615
010d0000183501835016350163501535015350113501135013352133521335213355113501135013350133501535015350163501635018350183501a3501a350133521335213352133551a3501a3501d3501d355
010d000037630376350c6753760037620376250c6753760037620376250c6753760037620376250c6753760037620376250c6753760037620376250c6753760037620376250c6753760037620376250c67537600
010d00001d3501d3501f3501f3501a3501a35018350183501a3521a3521a3521a35518350183501a3501a3501d3501d3501f3501f3501a3501a35018350183501a3521a3521a3521a3551f3501f3502135021350
010d0000223502235021350213501f3501f3501d3501d3501a3521a3521a3521a35518350183501a3501a3501835018350163501635015350153501135011350133521335213352133551a3501a3501d3501d355
010d000037630376350c6753760037620376250c6753760037620376250c6753760037620376250c6753760037620376250c6753760037620376250c675376000c675122000c6750c6750c6750f2000c6750c675
010d00000324003240032400324003240032400324003240032420324203242032420324203242032420324205240052400524005240052400524005240052400524205242052420524205242052420524205242
010d00000724007240072400724007240072400724007240072400724007240072400724007240072400724007242072420724207242072420724207242072420724207242072420724207242072420724207242
010d0000286701c661106510c64500000000000000000000376303763037625000000000000000000000000000000000000000000000000000000000000000003763037630376250000000000000000000000000
010d000000000000000000000000000000000000000000003763037630376250000000000000000000000000000000000000000000001f6301f6301f625000003763037630376250000000000000000000000000
010d00000c6753761537610376150c675376153761037615376303763037625376150c6753761537610376150c6753761537610376150c675376153761037615376303763037625376150c675376153761037615
010d00000c6753761537610376150c675376153761037615376303763037625376150c6753761537610376150c6753761537610376151f6301f6301f62537615376303763037625376150c675376153761037615
010d0000223502235021350213501f3501f3501d3501d3501a3521a3521a3521a35518350183501a3501a35018350183501635016350153501535011350113501335213352133521335500000000000000000000
010d00000724007240072400724007240072400724007240072420724207242072420724207242072420724200000000000000000000000000000000000000000c2400c2420c2420c2420a2400a2420a2420a242
010d00000c6753761537610376150c6753761537610376150c634106311364117641186511c6511f6611f66500000000000000000000000000000000000000000c6750000000000000000c675000000000000000
010d0000223502235021350213501f3501f3501d3501d3501a3521a3521a3521a35518350183501a3501a3501835018350163501635015350153501135011350133521335213352133551b3501b3501e3501e350
010d00000424004240042400424004240042400424004240042420424204242042420424204242042420424206240062400624006240062400624006240062400624206242062420624206242062420624206242
010d00000824008240082400824008240082400824008240082400824008240082400824008240082400824008242082420824208242082420824208242082420824208242082420824208242082420824208242
010d00001e3501e35020350203501b3501b35019350193501b3521b3521b3521b35519350193501b3501b3501e3501e35020350203501b3501b35019350193501b3521b3521b3521b35519350193501b3501b350
010d0000193501935017350173501635016350123501235014352143521435214355123501235014350143501635016350173501735019350193501b3501b350143521435214352143551b3501b3501e3501e355
010d00001e3501e35020350203501b3501b35019350193501b3521b3521b3521b35519350193501b3501b3501e3501e35020350203501b3501b35019350193501b3521b3521b3521b35520350203502235022350
010d00002335023350223502235020350203501e3501e3501b3521b3521b3521b35519350193501b3501b35019350193501735017350163501635012350123501435214352143521435500000000000000000000
010d00001415014150121501415014150121501415012150141501415012150141501415012150141501215014150141501215014150141501215014150121501415014150121501415014150121501415012150
010d00001414014140121401414014140121401414012140141301413012130141301413012130141301213014120141201212014120141201212014120121201411014110121101411014110141151410012100
010d00000f2300f2300d2300f2300f2300d2300f2300d2300f2300f2300d2300f2300f2300d2300f2300d2300f2300f2300d2300f2300f2300d2300f2300d2300f2300f2300d2300f2300f2300d2300f2300d230
010d00000f2200f2200d2200f2200f2200d2200f2200d2200f2200f2200d2200f2200f2200d2200f2200d2200f2100f2100d2100f2100f2100d2100f2100d2100f2100f2100d2100f2100f2100f2150f2000d200
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
010d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001805300000000000000018053000000000000000
010d00001805300000000000000018053000000000000000180530000000000000001805300000180000000018053000000000000000180530000018000000001807300000180731807318073000001807318073
010d00001805300000000000000018053000000000000000180530000000000000001805300000180000000018053000000000000000180530000000000000001805300000000000000018053000000000000000
__music__
01 01003f44
00 01423f44
00 01423f44
00 03023f44
00 04053f47
00 04063f44
00 04053f47
00 07063e44
00 04053f08
00 040a3f09
00 04053f08
00 0c0a3e0b
00 04050d08
00 040a0e09
00 04050d08
00 0c0a0f0b
00 120a1013
00 14051115
00 120a1013
00 14051115
00 160a1013
00 16051115
00 160a1017
00 19051118
00 1c1a4313
00 1d1b4315
00 1c1a4313
00 1d1b4315
00 1e1a4313
00 1f1b4315
00 1e1a4317
00 22213d20
00 04053f47
00 04063f44
00 04053f47
00 07063e44
00 04053f08
00 040a3f09
00 04053f08
00 0c0a3e0b
00 04050d08
00 040a0e09
00 04050d08
00 0c0a0f0b
00 120a1013
00 14051115
00 120a1013
00 14051115
00 160a1013
00 16051115
00 160a1017
00 19051123
00 12244326
00 14254327
00 12244326
00 14254327
00 00244326
00 41254327
00 40244328
00 41254329
00 002a432c
00 402b432d

